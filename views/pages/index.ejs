<%- include('../partials/header') %>

<main>
        <div class="unified-homepage">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="neon-text scan-line">BAMBI SLEEP CHURCH</h1>
            </div>
            
            <!-- Top Categories -->
            <div class="categories-view">
                <!-- Creators Card -->
                <div class="category-card">
                    <h2><span class="category-icon">üë•</span>Top Creators</h2>
                    <ul class="category-list">
                        <% if (creators && creators.length > 0) { %>
                            <% creators.slice(0, 15).forEach(creator => { %>
                                <li>
                                    <a href="<%= creator.url %>" target="_blank" class="creator-link">
                                        <div class="creator-info">                                            <div class="creator-main-row">                                                <span class="creator-name-main">
                                                    <% 
                                                    const fullName = creator.title || creator.name;
                                                    const parts = fullName.split(' - ');
                                                    const mainName = parts[0];
                                                    %>                                                    <%= mainName.length > 45 ? mainName.substring(0, 45) + '...' : mainName %>
                                                </span>
                                            </div>
                                            <div class="vote-stats">
                                                <div class="vote-stats-left">
                                                    <span>‚≠ê <%= creator.votes || 0 %></span>
                                                    <div class="vote-emojis">
                                                        <span class="vote-emoji upvote" data-type="creator" data-id="<%= creator.id %>" onclick="castVote(event, 'creator', '<%= creator.id %>', 'up')">‚úÖ</span>
                                                        <span class="vote-emoji downvote" data-type="creator" data-id="<%= creator.id %>" onclick="castVote(event, 'creator', '<%= creator.id %>', 'down')">‚ùå</span>
                                                    </div>
                                                </div>
                                                <div class="vote-stats-right">
                                                    <span>üëÅ <%= creator.views || 0 %></span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            <% }); %>
                        <% } else { %>
                            <li class="no-content-message">No creators yet</li>
                        <% } %>
                    </ul>
                </div>                <!-- Videos Card -->
                <div class="category-card">
                    <h2><span class="category-icon">üì∫</span>Top Videos</h2>
                    <ul class="category-list">
                        <% if (links && links.length > 0) { %>
                            <% const videos = links.filter(link => link.category === 'videos').slice(0, 15); %>
                            <% if (videos.length > 0) { %>
                                <% videos.forEach(link => { %>
                                    <li>
                                        <a href="<%= link.url %>" target="_blank" class="content-link">
                                            <div class="creator-info">                                                <div class="creator-main-row">
                                                    <span class="creator-name-main">
                                                        <% 
                                                        const fullTitle = link.title;
                                                        const parts = fullTitle.split(' - ');
                                                        const mainName = parts[0];
                                                        %>                                                        <%= mainName.length > 45 ? mainName.substring(0, 45) + '...' : mainName %>
                                                    </span>
                                                </div>
                                                <div class="vote-stats">
                                                    <div class="vote-stats-left">
                                                        <span>‚≠ê <%= link.votes || 0 %></span>
                                                        <div class="vote-emojis">
                                                            <span class="vote-emoji upvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'up')">‚úÖ</span>
                                                            <span class="vote-emoji downvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'down')">‚ùå</span>
                                                        </div>
                                                    </div>
                                                    <div class="vote-stats-right">
                                                        <span>üëÅ <%= link.views || 0 %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li class="no-content-message">No videos yet</li>
                            <% } %>
                        <% } %>
                    </ul>
                </div>                <!-- Audio Card -->
                <div class="category-card">
                    <h2><span class="category-icon">üéµ</span>Top Audios</h2>
                    <ul class="category-list">
                        <% if (links && links.length > 0) { %>
                            <% const audios = links.filter(link => link.category === 'audio').slice(0, 15); %>
                            <% if (audios.length > 0) { %>
                                <% audios.forEach(link => { %>
                                    <li>
                                        <a href="<%= link.url %>" target="_blank" class="content-link">
                                            <div class="creator-info">                                                <div class="creator-main-row">
                                                    <span class="creator-name-main">
                                                        <% 
                                                        const fullTitle = link.title;
                                                        const parts = fullTitle.split(' - ');
                                                        const mainName = parts[0];
                                                        %>                                                        <%= mainName.length > 45 ? mainName.substring(0, 45) + '...' : mainName %>
                                                    </span>
                                                </div>
                                                <div class="vote-stats">
                                                    <div class="vote-stats-left">
                                                        <span>‚≠ê <%= link.votes || 0 %></span>
                                                        <div class="vote-emojis">
                                                            <span class="vote-emoji upvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'up')">‚úÖ</span>
                                                            <span class="vote-emoji downvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'down')">‚ùå</span>
                                                        </div>
                                                    </div>
                                                    <div class="vote-stats-right">
                                                        <span>üëÅ <%= link.views || 0 %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li class="no-content-message">No audios yet</li>
                            <% } %>
                        <% } %>
                    </ul>
                </div>                <!-- Images Card -->
                <div class="category-card">
                    <h2><span class="category-icon">üñºÔ∏è</span>Top Images</h2>
                    <ul class="category-list">
                        <% if (links && links.length > 0) { %>
                            <% const images = links.filter(link => link.category && link.category !== 'audio' && link.category !== 'videos').slice(0, 15); %>
                            <% if (images.length > 0) { %>
                                <% images.forEach(link => { %>
                                    <li>
                                        <a href="<%= link.url %>" target="_blank" class="content-link">
                                            <div class="creator-info">                                                <div class="creator-main-row">
                                                    <span class="creator-name-main">
                                                        <% 
                                                        const fullTitle = link.title;
                                                        const parts = fullTitle.split(' - ');
                                                        const mainName = parts[0];
                                                        %>                                                        <%= mainName.length > 45 ? mainName.substring(0, 45) + '...' : mainName %>
                                                    </span>
                                                </div><div class="vote-stats">
                                                    <div class="vote-stats-left">
                                                        <span>‚≠ê <%= link.votes || 0 %></span>
                                                        <div class="vote-emojis">
                                                            <span class="vote-emoji upvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'up')">‚úÖ</span>
                                                            <span class="vote-emoji downvote" data-type="link" data-id="<%= link.id %>" onclick="castVote(event, 'link', '<%= link.id %>', 'down')">‚ùå</span>
                                                        </div>
                                                    </div>
                                                    <div class="vote-stats-right">
                                                        <span>üëÅ <%= link.views || 0 %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li class="no-content-message">No images yet</li>
                            <% } %>
                        <% } %>
                    </ul>
                </div>
            </div>            
            <!-- Platform Categories (organized like main categories) -->
            <div class="platform-categories-container" id="platformCategoriesContainer">
                <div class="loading-message">
                    Loading platforms...
                </div>
            </div>
        </div>
    </main>    <%- include('../partials/footer') %>
    
    <!-- Socket.IO for real-time communication -->
    <script src="/socket.io/socket.io.js"></script>    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to server via Socket.IO');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        // Listen for real-time updates
        socket.on('toolbox:linkUpdate', (data) => {
            console.log('Link update received:', data);
            // Refresh the page or update specific elements
            loadPlatformCategories();
        });

        socket.on('toolbox:analyticsUpdate', (data) => {
            console.log('Analytics update received:', data);
        });

        let allPlatforms = [];
        
        // Platform categories for filtering
        const platformCategories = {
            video: ['youtube', 'vimeo', 'dailymotion', 'twitch'],
            audio: ['soundcloud', 'spotify', 'bandcamp', 'anchor'],
            creator: ['patreon', 'ko-fi', 'onlyfans', 'subscribestar', 'gumroad', 'etsy'],
            hypno: ['bambicloud', 'hypnotube'],
            adult: ['pornhub', 'xvideos', 'xhamster'],
            social: ['twitter', 'reddit'],
            storage: ['google-drive', 'dropbox', 'mega']
        };        document.addEventListener('DOMContentLoaded', () => {
            loadPlatformCategories();
            initializeVoteButtons();
        });        async function loadPlatformCategories() {
            try {
                // Use static sample data instead of server API
                const platforms = getStaticPlatformData();
                allPlatforms = platforms;
                renderPlatformCategories(platforms);
            } catch (error) {
                console.error('Error loading platform categories:', error);
                showPlatformCategoriesError('Error loading platforms');
            }
        }        function getStaticPlatformData() {
            // Sample static data for development/standalone mode
            const baseData = [
                {
                    platform: 'youtube',
                    totalViews: 1250,
                    items: [
                        { id: 'yt1', title: 'Bambi Sleep - Basic Training Loop', url: 'https://youtube.com/watch?v=sample1', votes: 45, views: 320, linkId: 'yt1' },
                        { id: 'yt2', title: 'Advanced Bambi Training Session', url: 'https://youtube.com/watch?v=sample2', votes: 38, views: 285, linkId: 'yt2' },
                        { id: 'yt3', title: 'Bambi Reinforcement Audio', url: 'https://youtube.com/watch?v=sample3', votes: 32, views: 210, linkId: 'yt3' }
                    ]
                },
                {
                    platform: 'soundcloud',
                    totalViews: 890,
                    items: [
                        { id: 'sc1', title: 'Deep Bambi Programming', url: 'https://soundcloud.com/sample1', votes: 28, views: 195, linkId: 'sc1' },
                        { id: 'sc2', title: 'Bambi Maintenance Track', url: 'https://soundcloud.com/sample2', votes: 22, views: 165, linkId: 'sc2' }
                    ]
                },
                {
                    platform: 'patreon',
                    totalViews: 650,
                    items: [
                        { id: 'pt1', name: 'BambiCreator', title: 'BambiCreator - Premium Content', url: 'https://patreon.com/bambicreator', votes: 35, views: 240 },
                        { id: 'pt2', name: 'HypnoMaster', title: 'HypnoMaster - Advanced Training', url: 'https://patreon.com/hypnomaster', votes: 28, views: 180 }
                    ]
                }
            ];
            
            // Merge with crawled URLs from localStorage
            const mergedData = mergeCrawledUrls(baseData);
            
            // Apply local storage modifications to data
            return mergedData.map(platform => ({
                ...platform,
                items: platform.items.map(item => {
                    const itemId = item.id || item.linkId;
                    const type = item.linkId ? 'link' : 'creator';
                    
                    // Get local votes and views
                    const localVotes = parseInt(localStorage.getItem(`votes_${type}_${itemId}`)) || 0;
                    const localViews = parseInt(localStorage.getItem(`views_${type}_${itemId}`)) || 0;
                    
                    return {
                        ...item,
                        votes: (item.votes || 0) + localVotes,
                        views: (item.views || 0) + localViews
                    };
                })
            }));
        }

        // URL Updater Functions
        function mergeCrawledUrls(baseData) {
            // Get stored crawled URLs
            const crawledUrls = getCrawledUrls();
            if (!crawledUrls || crawledUrls.length === 0) {
                return baseData;
            }

            // Create a copy of base data to work with
            const mergedData = JSON.parse(JSON.stringify(baseData));
            const platformMap = {};
            
            // Create lookup map for existing platforms
            mergedData.forEach(platform => {
                platformMap[platform.platform] = platform;
            });

            // Process crawled URLs
            crawledUrls.forEach(crawledUrl => {
                const platformName = extractPlatformFromUrl(crawledUrl.url);
                if (!platformName) return;

                // Create platform if it doesn't exist
                if (!platformMap[platformName]) {
                    const newPlatform = {
                        platform: platformName,
                        totalViews: 0,
                        items: []
                    };
                    mergedData.push(newPlatform);
                    platformMap[platformName] = newPlatform;
                }

                // Add crawled URL to platform
                const platform = platformMap[platformName];
                const newItem = {
                    id: crawledUrl.id,
                    title: crawledUrl.title || crawledUrl.url,
                    url: crawledUrl.url,
                    votes: 0,
                    views: 0,
                    linkId: crawledUrl.id,
                    source: 'crawled',
                    addedAt: crawledUrl.addedAt
                };

                // Check if URL already exists
                const exists = platform.items.some(item => item.url === crawledUrl.url);
                if (!exists) {
                    platform.items.push(newItem);
                    platform.totalViews += newItem.views;
                }
            });

            return mergedData;
        }

        function addCrawledUrl(url, metadata = {}) {
            const crawledUrls = getCrawledUrls();
            const id = generateUniqueId();
            
            const newUrl = {
                id: id,
                url: url,
                title: metadata.title || url,
                description: metadata.description || '',
                type: metadata.type || 'website',
                addedAt: new Date().toISOString()
            };

            crawledUrls.push(newUrl);
            localStorage.setItem('crawledUrls', JSON.stringify(crawledUrls));
            
            // Refresh display
            loadPlatformCategories();
            
            return newUrl;
        }

        function addCrawledUrls(urlsArray) {
            if (!Array.isArray(urlsArray)) return;
            
            const crawledUrls = getCrawledUrls();
            const addedUrls = [];

            urlsArray.forEach(urlData => {
                const id = generateUniqueId();
                const newUrl = {
                    id: id,
                    url: urlData.url || urlData,
                    title: urlData.title || urlData.metadata?.title || urlData.url || urlData,
                    description: urlData.description || urlData.metadata?.description || '',
                    type: urlData.type || urlData.metadata?.type || 'website',
                    addedAt: new Date().toISOString()
                };

                // Check for duplicates
                const exists = crawledUrls.some(existing => existing.url === newUrl.url);
                if (!exists) {
                    crawledUrls.push(newUrl);
                    addedUrls.push(newUrl);
                }
            });

            if (addedUrls.length > 0) {
                localStorage.setItem('crawledUrls', JSON.stringify(crawledUrls));
                loadPlatformCategories();
                showNotification(`Added ${addedUrls.length} new URLs`, 'success');
            }

            return addedUrls;
        }

        function getCrawledUrls() {
            try {
                return JSON.parse(localStorage.getItem('crawledUrls') || '[]');
            } catch (e) {
                return [];
            }
        }

        function clearCrawledUrls() {
            localStorage.removeItem('crawledUrls');
            loadPlatformCategories();
            showNotification('Cleared all crawled URLs', 'info');
        }

        function extractPlatformFromUrl(url) {
            try {
                const hostname = new URL(url).hostname.toLowerCase();
                const platformDomains = {
                    'youtube.com': 'youtube',
                    'youtu.be': 'youtube',
                    'soundcloud.com': 'soundcloud',
                    'vimeo.com': 'vimeo',
                    'patreon.com': 'patreon',
                    'reddit.com': 'reddit',
                    'twitter.com': 'twitter',
                    'x.com': 'twitter',
                    'spotify.com': 'spotify',
                    'bandcamp.com': 'bandcamp',
                    'pornhub.com': 'pornhub',
                    'xvideos.com': 'xvideos',
                    'ko-fi.com': 'ko-fi',
                    'onlyfans.com': 'onlyfans',
                    'twitch.tv': 'twitch',
                    'dailymotion.com': 'dailymotion',
                    'anchor.fm': 'anchor',
                    'subscribestar.com': 'subscribestar',
                    'gumroad.com': 'gumroad',
                    'etsy.com': 'etsy',
                    'xhamster.com': 'xhamster',
                    'dropbox.com': 'dropbox',
                    'mega.nz': 'mega',
                    'drive.google.com': 'google-drive'
                };

                // Check for exact match
                if (platformDomains[hostname]) {
                    return platformDomains[hostname];
                }

                // Check for subdomain matches
                for (const [domain, platform] of Object.entries(platformDomains)) {
                    if (hostname.endsWith(domain)) {
                        return platform;
                    }
                }

                // Default to 'website' for unknown platforms
                return 'website';
            } catch (e) {
                return 'website';
            }
        }

        function generateUniqueId() {
            return 'crawled_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Expose URL updater functions globally for external access
        window.urlUpdater = {
            addUrl: addCrawledUrl,
            addUrls: addCrawledUrls,
            getUrls: getCrawledUrls,
            clearUrls: clearCrawledUrls,
            refreshDisplay: loadPlatformCategories
        };function renderPlatformCategories(platforms) {
            const container = document.getElementById('platformCategoriesContainer');
            
            if (!platforms || platforms.length === 0) {
                container.innerHTML = '<div class="loading-message">No platforms yet</div>';
                return;
            }
            
            // Sort by total platform views (totalViews) in descending order
            const sortedPlatforms = platforms.sort((a, b) => 
                (b.totalViews || 0) - (a.totalViews || 0)
            );
            
            container.innerHTML = '';
            
            sortedPlatforms.forEach(platform => {
                const categoryCard = createPlatformCategoryCard(platform);
                container.appendChild(categoryCard);
            });
            
            // Initialize vote button states after rendering platform categories
            initializeVoteButtons();
        }

        function createPlatformCategoryCard(platform) {
            const card = document.createElement('div');
            card.className = 'category-card platform-category-card';
            
            const faviconUrl = getPlatformFavicon(platform.platform);
              // Create favicon element with better error handling
            const faviconElement = faviconUrl ?                `<img src="${faviconUrl}" alt="${platform.platform}" class="platform-favicon platform-favicon-visible" onerror="this.className='platform-favicon platform-favicon-hidden'; this.nextElementSibling.className='platform-favicon fallback platform-favicon-visible';">
                 <span class="platform-favicon fallback platform-favicon-hidden">${platform.platform.charAt(0).toUpperCase()}</span>` :
                `<span class="platform-favicon fallback">${platform.platform.charAt(0).toUpperCase()}</span>`;
            
            // Get top 15 items from this platform, sorted by engagement
            const sortedItems = platform.items
                .sort((a, b) => ((b.votes || 0) * 10 + (b.views || 0)) - ((a.votes || 0) * 10 + (a.views || 0)))
                .slice(0, 15);
            
            card.innerHTML = `
                <h2>
                    <span class="category-icon">${faviconElement}</span>
                    ${platform.platform.charAt(0).toUpperCase() + platform.platform.slice(1)} (${platform.items.length})
                </h2>
                <ul class="category-list">
                    ${sortedItems.map(item => `
                        <li>
                            <a href="${item.url || item.link}" target="_blank" class="content-link">
                                <div class="creator-info">
                                    <div class="creator-main-row">                                        <span class="creator-name-main">
                                            ${getTruncatedTitle(item.title || item.name || 'Untitled')}
                                        </span>
                                    </div>                                    <div class="vote-stats">
                                        <div class="vote-stats-left">
                                            <span>‚≠ê ${item.votes || 0}</span>
                                            <div class="vote-emojis">
                                                <span class="vote-emoji upvote" data-type="${item.linkId ? 'link' : 'creator'}" data-id="${item.id || item.linkId}" onclick="castVote(event, '${item.linkId ? 'link' : 'creator'}', '${item.id || item.linkId}', 'up')">‚úÖ</span>
                                                <span class="vote-emoji downvote" data-type="${item.linkId ? 'link' : 'creator'}" data-id="${item.id || item.linkId}" onclick="castVote(event, '${item.linkId ? 'link' : 'creator'}', '${item.id || item.linkId}', 'down')">‚ùå</span>
                                            </div>
                                        </div>
                                        <div class="vote-stats-right">
                                            <span>üëÅ ${item.views || 0}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                    `).join('')}
                    ${platform.items.length > 15 ? `
                        <li class="more-content-indicator">
                            ...and ${platform.items.length - 15} more items
                        </li>
                    ` : ''}
                    ${platform.items.length === 0 ? `
                        <li class="no-content-message">No content yet</li>
                    ` : ''}
                </ul>
            `;
            
            // Add click handler to navigate to platform feed
            card.addEventListener('click', (e) => {
                // Only navigate if not clicking on a link
                if (!e.target.closest('a')) {
                    window.location.href = `/platforms/${platform.platform}`;
                }
            });
            
            return card;
        }        function getTruncatedTitle(title) {
            const parts = title.split(' - ');
            const mainTitle = parts[0];
            return mainTitle.length > 45 ? mainTitle.substring(0, 45) + '...' : mainTitle;
        }function getPlatformFavicon(platform) {
            // Use Google's favicon service for reliable favicon fetching
            const platformDomains = {
                'youtube': 'youtube.com',
                'soundcloud': 'soundcloud.com',
                'vimeo': 'vimeo.com',
                'patreon': 'patreon.com',
                'reddit': 'reddit.com',
                'twitter': 'twitter.com',
                'spotify': 'spotify.com',
                'bandcamp': 'bandcamp.com',
                'pornhub': 'pornhub.com',
                'xvideos': 'xvideos.com',
                'ko-fi': 'ko-fi.com',
                'onlyfans': 'onlyfans.com',
                'twitch': 'twitch.tv',
                'dailymotion': 'dailymotion.com',
                'anchor': 'anchor.fm',
                'subscribestar': 'subscribestar.com',
                'gumroad': 'gumroad.com',
                'etsy': 'etsy.com',
                'xhamster': 'xhamster.com',
                'dropbox': 'dropbox.com',
                'mega': 'mega.nz',
                'google-drive': 'drive.google.com',
                'bambicloud': null, // Custom platform, no standard favicon
                'hypnotube': null // Custom platform, no standard favicon
            };
            
            const domain = platformDomains[platform.toLowerCase()];
            if (domain) {
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
            }
            
            return null;
        }function showPlatformCategoriesError(message) {
            const container = document.getElementById('platformCategoriesContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }        // Voting functionality with real-time Socket.IO support
        function castVote(event, type, id, voteType) {
            event.preventDefault();
            event.stopPropagation();
            
            const emoji = event.target;
            const itemContainer = emoji.closest('.creator-info');
            const upvoteEmoji = itemContainer.querySelector('.upvote');
            const downvoteEmoji = itemContainer.querySelector('.downvote');            
            const voteStats = itemContainer.querySelector('.vote-stats');
            const voteCountSpan = voteStats.querySelector('.vote-stats-left span');
            
            const upvoteCookieKey = `voted_${type}_${id}_up`;
            const downvoteCookieKey = `voted_${type}_${id}_down`;
            
            // Check current vote state
            const hasUpvoted = hasVoted(upvoteCookieKey);
            const hasDownvoted = hasVoted(downvoteCookieKey);
            
            // Get bambi name
            let bambiName = localStorage.getItem('bambiName');
            if (!bambiName) {
                bambiName = prompt('Enter your Bambi name:');
                if (!bambiName) return;
                localStorage.setItem('bambiName', bambiName);
            }
            
            // Determine the action to take
            let action = '';
            let newVoteValue = 0;
            
            if (voteType === 'up') {
                if (hasUpvoted) {
                    // Remove upvote
                    action = 'remove_upvote';
                    newVoteValue = -1;
                    removeVotingCookie(upvoteCookieKey);
                    upvoteEmoji.classList.remove('active');
                } else {
                    // Add upvote (remove downvote if exists)
                    action = 'add_upvote';
                    newVoteValue = hasDownvoted ? 2 : 1; // +2 if switching from downvote, +1 if neutral
                    if (hasDownvoted) {
                        removeVotingCookie(downvoteCookieKey);
                        downvoteEmoji.classList.remove('active');
                    }
                    createVotingCookie(upvoteCookieKey, bambiName);
                    upvoteEmoji.classList.add('active');
                }
            } else if (voteType === 'down') {
                if (hasDownvoted) {
                    // Remove downvote
                    action = 'remove_downvote';
                    newVoteValue = 1;
                    removeVotingCookie(downvoteCookieKey);
                    downvoteEmoji.classList.remove('active');
                } else {
                    // Add downvote (remove upvote if exists)
                    action = 'add_downvote';
                    newVoteValue = hasUpvoted ? -2 : -1; // -2 if switching from upvote, -1 if neutral
                    if (hasUpvoted) {
                        removeVotingCookie(upvoteCookieKey);
                        upvoteEmoji.classList.remove('active');
                    }
                    createVotingCookie(downvoteCookieKey, bambiName);
                    downvoteEmoji.classList.add('active');
                }
            }
              
            // Update vote count immediately for better UX
            const currentVotes = parseInt(voteCountSpan.textContent.replace('‚≠ê ', '')) || 0;
            const newVoteCount = currentVotes + newVoteValue;
            voteCountSpan.textContent = `‚≠ê ${newVoteCount}`;
              // Send vote to server for real-time broadcasting (if available)
            if (socket && socket.connected) {
                console.log('üì° Sending vote to server for real-time broadcast');
                
                // Emit vote data via Socket.IO
                socket.emit('toolbox:execute', {
                    tool: 'linkManager',
                    method: 'voteLink',
                    params: {
                        linkId: id,
                        itemId: id,
                        itemType: type,
                        type: voteType === 'up' ? 'upvote' : 'downvote',
                        voter: bambiName,
                        action: action
                    }
                }, (response) => {
                    if (response && response.success) {
                        console.log('‚úÖ Vote submitted successfully via Socket.IO');
                    } else {
                        console.error('‚ùå Error submitting vote via Socket.IO:', response);
                    }
                });

                // Also send analytics event
                socket.emit('toolbox:execute', {
                    tool: 'analytics',
                    method: 'trackEvent',
                    params: {
                        type: 'vote_cast',
                        userId: bambiName,
                        data: { itemType: type, itemId: id, voteType: voteType, action: action }
                    }
                });
            } else {
                // Fallback to local storage
                console.log('üîÑ Socket not connected, using local storage');
                const voteKey = `votes_${type}_${id}`;
                const currentStoredVotes = parseInt(localStorage.getItem(voteKey)) || 0;
                localStorage.setItem(voteKey, currentStoredVotes + newVoteValue);
            }
            
            console.log('Vote cast:', action);
            
            // Reload platform categories to reflect changes
            setTimeout(() => {
                loadPlatformCategories();
            }, 500);
        }
          function createVotingCookie(cookieKey, bambiName) {
            const expiryDate = new Date();
            expiryDate.setMinutes(expiryDate.getMinutes() + 60); // 60 minutes from now
            
            const cookieValue = JSON.stringify({
                voted: true,
                bambiname: bambiName,
                timestamp: new Date().toISOString()
            });
            
            document.cookie = `${cookieKey}=${encodeURIComponent(cookieValue)}; expires=${expiryDate.toUTCString()}; path=/`;
        }
        
        function removeVotingCookie(cookieKey) {
            document.cookie = `${cookieKey}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
        }
        
        function hasVoted(cookieKey) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === cookieKey) {
                    try {
                        const voteData = JSON.parse(decodeURIComponent(value));
                        return voteData.voted === true;
                    } catch (e) {
                        return false;
                    }
                }
            }
            return false;
        }
          function initializeVoteButtons() {
            // Check and update vote emoji states on page load
            document.querySelectorAll('.creator-info').forEach(itemContainer => {
                const upvoteEmoji = itemContainer.querySelector('.upvote');
                const downvoteEmoji = itemContainer.querySelector('.downvote');
                
                if (upvoteEmoji && downvoteEmoji) {
                    const type = upvoteEmoji.dataset.type;
                    const id = upvoteEmoji.dataset.id;
                    
                    const upvoteCookieKey = `voted_${type}_${id}_up`;
                    const downvoteCookieKey = `voted_${type}_${id}_down`;
                    
                    if (hasVoted(upvoteCookieKey)) {
                        upvoteEmoji.classList.add('active');
                    }
                    
                    if (hasVoted(downvoteCookieKey)) {
                        downvoteEmoji.classList.add('active');
                    }
                }
            });
        }        // WebSocket functionality removed - now using local data only
        console.log('Running in standalone mode - no server dependencies');
        console.log('URL Updater available via: window.urlUpdater');
        console.log('Example usage:');
        console.log('  window.urlUpdater.addUrl("https://youtube.com/watch?v=example", {title: "Example Video"})');
        console.log('  window.urlUpdater.addUrls([{url: "https://soundcloud.com/example", title: "Example Audio"}])');
        console.log('  window.urlUpdater.getUrls() // View all crawled URLs');
        console.log('  window.urlUpdater.clearUrls() // Clear all crawled URLs');

        // Track clicks on all URLs on the root page
        function initializeClickTracking() {
            // Track clicks on content links (videos, audios, images, platform content)
            document.querySelectorAll('.content-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    const linkElement = event.currentTarget;
                    const voteEmoji = linkElement.querySelector('.vote-emoji[data-type="link"]');
                    
                    if (voteEmoji && voteEmoji.dataset.id) {
                        const linkId = voteEmoji.dataset.id;
                        trackLinkView(linkId);
                    }
                });
            });

            // Track clicks on creator links
            document.querySelectorAll('.creator-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    const linkElement = event.currentTarget;
                    const voteEmoji = linkElement.querySelector('.vote-emoji[data-type="creator"]');
                    
                    if (voteEmoji && voteEmoji.dataset.id) {
                        const creatorId = voteEmoji.dataset.id;
                        trackCreatorView(creatorId);
                    }
                });
            });
        }        // Track link view using localStorage
        async function trackLinkView(linkId) {
            try {
                const viewKey = `views_link_${linkId}`;
                const currentViews = parseInt(localStorage.getItem(viewKey)) || 0;
                const newViews = currentViews + 1;
                localStorage.setItem(viewKey, newViews);
                
                // Update view count in UI if element exists
                const viewElement = document.querySelector(`[data-id="${linkId}"]`)?.closest('.creator-info')?.querySelector('.vote-stats-right span');
                if (viewElement) {
                    viewElement.textContent = `üëÅ ${newViews}`;
                }
            } catch (error) {
                console.error('Error tracking link view:', error);
            }
        }

        // Track creator view using localStorage
        async function trackCreatorView(creatorId) {
            try {
                const viewKey = `views_creator_${creatorId}`;
                const currentViews = parseInt(localStorage.getItem(viewKey)) || 0;
                const newViews = currentViews + 1;
                localStorage.setItem(viewKey, newViews);
                
                // Update view count in UI if element exists
                const viewElement = document.querySelector(`[data-id="${creatorId}"]`)?.closest('.creator-info')?.querySelector('.vote-stats-right span');
                if (viewElement) {
                    viewElement.textContent = `üëÅ ${newViews}`;
                }
            } catch (error) {
                console.error('Error tracking creator view:', error);
            }
        }

        // Initialize click tracking when DOM is ready and after platform categories load
        document.addEventListener('DOMContentLoaded', initializeClickTracking);
        
        // Re-initialize click tracking after platform categories are loaded
        const originalRenderPlatformCategories = renderPlatformCategories;        renderPlatformCategories = function(platforms) {
            originalRenderPlatformCategories(platforms);
            // Re-add event listeners after DOM update
            setTimeout(initializeClickTracking, 100);
        };
        
        // Real-time update handlers for Socket.IO
        window.handleContentUpdate = function(data) {
            console.log('üîÑ Handling real-time content update:', data);
            
            if (data.type === 'newLink') {
                // Add new content to the display
                loadPlatformCategories(); // Refresh the categories
                
                // Show notification
                showNotification(`New ${data.data.type} added: ${data.data.title}`, 'success');
            }
        };
        
        window.handleVoteUpdate = function(data) {
            console.log('üó≥Ô∏è Handling real-time vote update:', data);
            
            // Update vote count in UI
            const voteElement = document.querySelector(`[data-id="${data.itemId}"]`)?.closest('.creator-info')?.querySelector('.vote-stats-left span');
            if (voteElement) {
                voteElement.textContent = `‚≠ê ${data.newVoteCount}`;
            }
            
            // Refresh platform categories to show updated vote counts
            setTimeout(() => {
                loadPlatformCategories();
            }, 100);
        };
        
        window.handleTemplateUpdate = function(data) {
            console.log('üìÑ Handling template update:', data);
            
            if (data.template === 'index') {
                if (data.action === 'addContent') {
                    // Refresh the entire display
                    loadPlatformCategories();
                } else if (data.action === 'updateVotes') {
                    // Just update the specific vote count
                    const voteElement = document.querySelector(`[data-id="${data.data.itemId}"]`)?.closest('.creator-info')?.querySelector('.vote-stats-left span');
                    if (voteElement) {
                        voteElement.textContent = `‚≠ê ${data.data.newVoteCount}`;
                    }
                }
            }
        };
        
        // Notification system for real-time updates
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--color-primary-cyan);
                color: var(--color-bg-primary);
                padding: 1rem;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
    </script>

    <%- include('../partials/footer') %>
